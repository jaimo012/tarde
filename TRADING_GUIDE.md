# 📈 자동매매 시스템 가이드

## 🎯 개요

본 시스템은 DART 공시 정보를 기반으로 주식을 자동으로 매매하는 시스템입니다. 단일판매공급계약 공시를 모니터링하고, 투자 가치가 높은 종목을 자동으로 매수하여 익절/손절을 실행합니다.

**⚠️ 중요: 본 시스템은 실제 자금을 사용하므로 각별한 주의가 필요합니다.**

## 🔧 시스템 구성

### 1. 핵심 모듈

#### 1.1 키움증권 API 클라이언트 (`src/trading/kiwoom_client.py`)
- OAuth 2.0 인증 및 토큰 자동 갱신
- 예수금 조회, 잔고 조회, 현재가 조회
- 매수/매도 주문 실행
- 주문 체결 확인
- API 호출 제한 관리 (초당 5회, 일일 10,000회)

#### 1.2 주문 관리자 (`src/trading/order_manager.py`)
- 시장가 전액 매수 (예수금 100% 사용)
- 지정가 익절/손절 매도
- 수수료 계산 (0.018%)
- 호가 단위 자동 조정

#### 1.3 포지션 관리자 (`src/trading/position_manager.py`)
- 보유 종목 실시간 조회
- 매수일 추적 및 보유 기간 계산
- 보유 기간별 매도 전략 실행

#### 1.4 거래 전략 (`src/trading/trading_strategy.py`)
- 매수 조건 확인
- 매도 전략 실행
- 리스크 관리

### 2. 데이터 관리

#### 2.1 구글 시트 "거래내역" 시트
자동으로 생성되며 다음 정보를 기록합니다:
- **매수 정보**: 종목코드, 종목명, 매수일시, 매수가, 수량, 금액
- **매도 정보**: 매도일시, 매도가, 수량, 금액, 수익금, 수익률
- **상태**: 보유중 / 매도완료
- **사유**: 익절, 손절, 보유기간 경과 등

## 📊 거래 전략

### 매수 조건 (모두 충족 시 자동 매수)

1. **공시 조건**
   - 단일판매공급계약 신규 공시
   - 접수일자가 당일 (KST 기준)

2. **투자 점수 조건**
   - 투자 점수 **8점 이상** (10점 만점)
   - 분석 항목: 시장지수, 시가총액, 매출 대비 계약 비율, 거래량, 캔들 상태

3. **시장 조건**
   - 한국 주식시장 개장일
   - 거래 가능 시간 (09:00 ~ 15:20)

4. **계좌 조건**
   - 보유 종목 없음 (한 종목 올인 전략)
   - 예수금 10,000원 이상

### 매도 전략

#### 1. 기본 익절 전략
- **매수 즉시**: 매수가 **+3%** 지정가 매도 주문 설정
- 목표: 빠른 익절 실현

#### 2. 5일 경과 시
- **현재가가 매수가 ~ 매수가+3% 사이**
  - → **시장가 매도** (소폭 이익 확정)
- **현재가가 매수가 미만**
  - → 매수가 **-1% 손절가** 지정가 매도 설정

#### 3. 10일 경과 시
- **무조건 시장가 매도**
- 이유: 장기 보유 방지, 자금 회전율 향상

## 🔒 안전장치

### 1. 거래 제한
- **동시 보유**: 1종목만 (분산 투자 없음)
- **매수 금액**: 예수금 100% (레버리지 사용 안 함)
- **최소 예수금**: 10,000원 이하 시 거래 중지

### 2. 시간 제한
- **매수 시간**: 09:00 ~ 15:20 (마감 10분 전까지)
- **매도 시간**: 09:00 ~ 15:30
- **휴장일**: 자동 거래 중지

### 3. API 제한 준수
- **초당 호출**: 최대 5회
- **일일 호출**: 최대 10,000회
- **Circuit Breaker**: 5회 연속 실패 시 자동 중지

### 4. 중복 실행 방지
- 프로세스 락 파일 사용
- 다중 인스턴스 실행 차단

### 5. 금액 정확성
- `Decimal` 타입 사용 (부동소수점 오류 방지)
- 수수료 정확한 반영
- 호가 단위 자동 조정

## 📱 슬랙 알림

### 알림 종류

1. **🔵 매수 시작 알림**
   - 종목명, 투자 점수, 계약 정보

2. **✅ 매수 체결 알림**
   - 체결가, 수량, 총 금액

3. **📝 매도 주문 알림**
   - 주문 유형 (시장가/지정가), 목표가, 사유

4. **💰 매도 체결 알림**
   - 매도가, 수익률, 실현 손익

5. **🚨 오류 알림**
   - API 오류, 주문 실패, 시스템 오류

## 🚀 실행 방법

### 로컬 환경

```bash
# 가상환경 활성화
.\venv\Scripts\Activate.ps1

# 환경변수 설정 (.env 파일)
KIWOOM_APP_KEY=your_app_key
KIWOOM_APP_SECRET=your_app_secret
KIWOOM_ACCOUNT_NUMBER=your_account_number
TRADING_MODE=LIVE

# 실행
python run.py
```

### 클라우드타입 환경

클라우드타입 대시보드에서 환경변수 설정:
```
KIWOOM_APP_KEY = your_app_key
KIWOOM_APP_SECRET = your_app_secret
KIWOOM_ACCOUNT_NUMBER = your_account_number
TRADING_MODE = LIVE
```

배포 후 자동 실행됩니다.

## 📊 성능 지표

### 백테스트 결과 (예시)
- **기간**: 2024.01 ~ 2024.12
- **총 거래**: 48건
- **승률**: 62.5%
- **평균 수익률**: +1.8%
- **최대 손실**: -2.1%

**주의**: 과거 성과가 미래 수익을 보장하지 않습니다.

## 🔧 트러블슈팅

### 1. API 인증 실패
**증상**: "키움증권 API 인증 실패"
**해결책**:
- 앱키/시크릿 확인
- IP 화이트리스트 등록 확인
- 계좌 활성화 상태 확인

### 2. 매수 실행 안 됨
**증상**: 조건 충족인데 매수 안 됨
**해결책**:
- 이미 보유 종목이 있는지 확인
- 예수금이 충분한지 확인
- 거래 시간인지 확인
- 로그 파일 확인: `logs/dart_scraper.log`

### 3. 매도 주문 설정 안 됨
**증상**: 매수 후 매도 주문이 설정되지 않음
**해결책**:
- 체결이 완료되었는지 확인
- API 호출 한도 확인
- 수동으로 키움 앱에서 확인

### 4. 중복 실행 방지
**증상**: "다른 프로세스가 실행 중입니다"
**해결책**:
- `logs/trading.lock` 파일 삭제
- 실제로 다른 프로세스가 실행 중이면 종료 후 재시작

## 📋 모니터링 체크리스트

### 매일 확인 사항
- [ ] 거래내역 시트 확인
- [ ] 슬랙 알림 확인
- [ ] 로그 파일 오류 확인
- [ ] API 호출 한도 확인

### 매주 확인 사항
- [ ] 수익률 분석
- [ ] 전략 효율성 검토
- [ ] 시스템 안정성 점검

### 매월 확인 사항
- [ ] 월간 성과 리포트 작성
- [ ] 전략 파라미터 조정 검토
- [ ] 시스템 업데이트 확인

## ⚖️ 법적 고지

**본 시스템은 투자자문이 아닙니다.**
- 본 시스템의 거래 결정은 사용자의 책임입니다
- 투자 손실 가능성을 충분히 인지하시기 바랍니다
- 자동매매는 예상치 못한 시장 변동에 취약할 수 있습니다
- 시스템 오류로 인한 손실 가능성이 있습니다

**투자 전 반드시 `RISK_DISCLOSURE.md`를 읽어주시기 바랍니다.**

## 📞 지원

- 시스템 이슈: GitHub Issues
- 키움증권 API 문의: 1588-8688
- 긴급 상황: 슬랙 알림 확인 후 수동 조치

---

**마지막 업데이트**: 2025-10-19
**버전**: 4.0.0 (자동매매 시스템)

